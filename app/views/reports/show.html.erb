<div class="panel">
  <div class="panel-heading">Report: <%= @report.time %></div>

  <div class="btn-toolbar">
    <%= link_to "Back", node_path(@report.node), :class => 'btn btn-sm btn-default' %>
    <%= link_to "Delete", @report, :method => :delete, :confirm => "Are you sure?", :class => 'btn btn-sm btn-danger pull-right' %>
  </div>

  <br>

  <div class="tabbable">
    <ul class="nav nav-tabs">
      <li class="active"><a href="#metrics" data-toggle="tab">Metrics</a></li>
      <li><a href="#log" data-toggle="tab">Log</a></li>
      <li><a href="#events" data-toggle="tab">Events</a></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane active" id="metrics">
          <svg id="time_chart" style="display:inline;height:320px;width:320px"></svg>
          <svg id="resource_chart" style="display:inline;height:320px;width:320px"></svg>
        <script src="/lib/d3.v3.js"></script>
        <script src="/nv.d3.js"></script>
        <script src="/src/models/legend.js"></script>
        <script src="/src/models/pie.js"></script>
        <script src="/src/models/pieChart.js"></script>
        <script src="/src/utils.js"></script>
        <script>
        nv.addGraph(function() {
          var chart = nv.models.pieChart()
              .x(function(d) { return d.label })
              .y(function(d) { return d.value })
              .showLabels(false);

            d3.select("#time_chart")
                .datum(timeData())
              .transition().duration(1200)
                .call(chart);

            d3.select("#resource_chart")
                .datum(resourceData())
              .transition().duration(1200)
                .call(chart);
          return chart;
        });

        function timeData() {
          return [
          {
            key: "Time",
            values: <%= @report.metrics.where(:category => "Time").reject {|m| m.name == "Total"}.collect {|metric| {:label => metric.name, :value => metric.value}}.to_json.html_safe %>
          }
          ];
        }
        function resourceData() {
          return [
          {
            key: "Resources",
            values: <%= @report.metrics.where(:category => "Resources").reject {|m| m.name == "Total"}.collect {|metric| {:label => metric.name, :value => metric.value}}.to_json.html_safe %>
          }
          ];
        }
        </script>
        <% @report.metrics.group(:category).each do |category| %>
          <table class="table table-bordered table-condensed table-striped">
            <tr>
              <th><%= category.category %></th>
              <th></th>
            </tr>
            <% @report.metrics.where(:category => category.category).each do |metric| %>
              <tr>
                <td><%= metric.name %></td>
                <td><%= metric.value %></td>
              </tr>
            <% end %>
          </table>
        <% end %>
      </div>
      <div class="tab-pane" id="log">
        <table class="table table-bordered table-condensed table-striped">
          <tr>
            <th>Time</th>
            <th>Level</th>
            <th>Message</th>
          </tr>
          <% @report.report_logs.each do |log| %>
            <tr>
              <td><%= log.time %></td>
              <td><%= log.level %></td>
              <td><%= log.message %></td>
            </tr>
          <% end %>
        </table>
      </div>
      <div class="tab-pane" id="events">
        <table class="table table-bordered table-condensed table-striped">
          <tr>
            <th>Name</th>
            <th>Changed</th>
            <th>Skipped</th>
            <th>Failed</th>
          </tr>
          <% @report.resource_statuses.each do |status| %>
            <tr>
              <td><%= status.title %></td>
              <td><%= status.is_changed ? "Changed" : "" %></td>
              <td><%= status.skipped ? "Skipped" : "" %></td>
              <td><%= status.failed ? "Failed" : "" %></td>
            </tr>
          <% end %>
        </table>
      </div>
    </div>
  </div>
</div>
